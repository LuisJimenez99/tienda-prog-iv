{% load static %}

<!-- L贸gica de detecci贸n de dieta (Backend en el Frontend) -->
{% with conflicto_dieta=False motivo_conflicto="" %}
    
    {% if user.is_authenticated %}
        {% if user.perfil.es_vegetariano and not producto.es_vegetariano %}
            <div style="display:none;" data-set-conflicto="true" data-motivo="Contiene carne"></div>
        {% elif user.perfil.es_vegano and not producto.es_vegano %}
            <div style="display:none;" data-set-conflicto="true" data-motivo="Contiene derivados animales"></div>
        {% elif user.perfil.es_celiaco and not producto.es_sin_tacc %}
            <div style="display:none;" data-set-conflicto="true" data-motivo="Contiene Gluten (TACC)"></div>
        {% endif %}
    {% endif %}

    <div class="tarjeta-harvest {% if producto.stock <= 0 %}agotado{% endif %} producto-card-js" 
         data-id="{{ producto.id }}">
        
        <!-- Capa de advertencia dietaria (visible solo si hay conflicto) -->
        <div class="diet-warning-overlay">
            <span> No apto para tu dieta</span>
        </div>

        <!-- Bot贸n de Favorito (Coraz贸n) -->
        {% if user.is_authenticated %}
        <button class="btn-favorito-harvest {% if user in producto.favoritos.all %}activo{% endif %}" 
                data-id="{{ producto.id }}" 
                onclick="toggleFavorito(this)" 
                aria-label="A帽adir a favoritos">
            <i class="fas fa-heart"></i>
        </button>
        {% endif %}

        <!-- Imagen del Producto -->
        <div class="harvest-img-box">
            <a href="{% url 'detalle_producto' producto.id %}">
                {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" loading="lazy">
                {% else %}
                    <img src="{% static 'images/placeholder_vianda.png' %}" alt="{{ producto.nombre }}" loading="lazy">
                {% endif %}
            </a>
            
            <!-- Etiquetas Nutricionales (Badges) -->
            <div class="harvest-badges">
                {% if producto.es_sin_tacc %}<span class="badge-h badge-tacc">Sin TACC</span>{% endif %}
                {% if producto.es_vegano %}<span class="badge-h badge-vegano">Vegano</span>{% endif %}
            </div>
        </div>

        <!-- Informaci贸n y Precios -->
        <div class="harvest-info">
            <span class="harvest-cat">{{ producto.categoria.nombre|default:"General" }}</span>
            
            <h3>
                <a href="{% url 'detalle_producto' producto.id %}">{{ producto.nombre }}</a>
            </h3>
            
            <div class="harvest-price-row">
                <span class="price">${{ producto.precio|floatformat:0 }}</span>
                
                {% if producto.stock > 0 %}
                <!-- Bot贸n de Agregar (Rectangular Redondeado con Texto) -->
                <button class="add-to-cart-btn btn-harvest-add" 
                    data-id="{{ producto.id }}" 
                    data-nombre="{{ producto.nombre }}" 
                    data-precio="{{ producto.precio }}" 
                    data-imagen="{{ producto.imagen.url }}">
                    <i class="fas fa-shopping-basket"></i> AGREGAR
                </button>
                {% else %}
                <span class="no-stock">Agotado</span>
                {% endif %}
            </div>
        </div>
    </div>
{% endwith %}

<!-- Script para activar la advertencia visual de dieta -->
<script>
    (function() {
        const scripts = document.getElementsByTagName('script');
        const currentScript = scripts[scripts.length - 1];
        const card = currentScript.previousElementSibling;
        const conflictMarker = card ? card.previousElementSibling : null;
        
        if (conflictMarker && conflictMarker.getAttribute('data-set-conflicto') === 'true') {
            card.classList.add('producto-incompatible');
            const warningText = card.querySelector('.diet-warning-overlay span');
            if(warningText) warningText.innerText = "锔 " + conflictMarker.getAttribute('data-motivo');
        }
    })();
</script>