{% load static %}

{% with conflicto_dieta=False motivo_conflicto="" %}
    {% if user.is_authenticated %}
        {% if user.perfil.es_vegetariano and not producto.es_vegetariano %}
            <div style="display:none;" data-set-conflicto="true" data-motivo="Contiene carne"></div>
        {% elif user.perfil.es_vegano and not producto.es_vegano %}
            <div style="display:none;" data-set-conflicto="true" data-motivo="Contiene derivados animales"></div>
        {% elif user.perfil.es_celiaco and not producto.es_sin_tacc %}
            <div style="display:none;" data-set-conflicto="true" data-motivo="Contiene Gluten"></div>
        {% endif %}
    {% endif %}

    <div class="tarjeta-hot {% if producto.stock <= 0 %}agotado{% endif %} producto-card-js" 
         data-id="{{ producto.id }}">
        
        <div class="diet-warning-overlay"><span>ðŸš« No apto</span></div>

        <!-- Etiqueta HOT -->
        <div class="hot-badge">ðŸ”¥ HOT</div>

        <!-- BOTÃ“N FAVORITO (CORREGIDO) -->
        {% if user.is_authenticated %}
        <button class="btn-favorito-hot {% if user in producto.favoritos.all %}activo{% endif %}" 
                data-id="{{ producto.id }}" 
                onclick="toggleFavorito(this)"
                aria-label="AÃ±adir a favoritos">
            <i class="fas fa-heart"></i>
        </button>
        {% endif %}

        <div class="hot-img">
             <a href="{% url 'detalle_producto' producto.id %}">
                {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" loading="lazy">
                {% else %}
                    <img src="{% static 'images/placeholder_vianda.png' %}" alt="{{ producto.nombre }}" loading="lazy">
                {% endif %}
             </a>
        </div>

        <div class="hot-content">
            <h3>{{ producto.nombre }}</h3>
            <div class="hot-price">
                <!-- Simulamos un precio anterior tachado para efecto visual -->
                <span class="old-price">${{ producto.precio|add:"500"|floatformat:0 }}</span>
                <span class="new-price">${{ producto.precio|floatformat:0 }}</span>
            </div>
            
            {% if producto.stock > 0 %}
            <button class="hot-add-btn add-to-cart-btn" 
                data-id="{{ producto.id }}" 
                data-nombre="{{ producto.nombre }}" 
                data-precio="{{ producto.precio }}" 
                data-imagen="{{ producto.imagen.url }}">
                COMPRAR AHORA
            </button>
            {% else %}
            <span class="hot-no-stock">SIN STOCK</span>
            {% endif %}
        </div>
    </div>
{% endwith %}

<script>
    (function() {
        const scripts = document.getElementsByTagName('script');
        const currentScript = scripts[scripts.length - 1];
        const card = currentScript.previousElementSibling;
        const conflictMarker = card ? card.previousElementSibling : null;
        if (conflictMarker && conflictMarker.getAttribute('data-set-conflicto') === 'true') {
            card.classList.add('producto-incompatible');
        }
    })();
</script>