{% extends 'panel_gestor/base_panel.html' %}
{% load static %}

{% block title %}Gestión de Pedidos{% endblock %}

{% block extra_css %}
<style>
    /* Filtros Superiores */
    .filters-bar { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn {
        padding: 8px 16px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 600;
        background: white; border: 1px solid #e2e8f0; color: #64748b; transition: all 0.2s; white-space: nowrap;
    }
    .filter-btn:hover { border-color: var(--brand-color); color: var(--brand-color); }
    .filter-btn.active { background: var(--brand-color); color: white; border-color: var(--brand-color); }

    /* Grilla de Pedidos */
    .pedidos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }

    /* Tarjeta de Pedido */
    .pedido-card {
        background: white; border-radius: 12px; border: 1px solid #e2e8f0;
        overflow: hidden; display: flex; flex-direction: column;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .pedido-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

    .card-header-p { padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .pedido-id { font-weight: 700; color: #1e293b; }

    .card-body-p { padding: 15px; flex: 1; }
    .cliente-info { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .avatar-mini { width: 30px; height: 30px; background: #e0f2fe; color: #0369a1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
    
    .items-list { list-style: none; padding: 0; margin: 0; }
    .item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px dashed #f1f5f9; padding-bottom: 5px; }
    .item-cant { font-weight: 700; color: var(--brand-color); margin-right: 5px; }

    .card-footer-p { padding: 15px; border-top: 1px solid #e2e8f0; background: white; }
    
    /* Botones de Acción */
    .actions-row { display: flex; gap: 10px; }
    .btn-action { 
        flex: 1; padding: 8px; border-radius: 6px; text-align: center; text-decoration: none; 
        font-size: 0.85rem; font-weight: 600; transition: opacity 0.2s; border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-cocinar { background: #f59e0b; color: white; } /* Amarillo */
    .btn-despachar { background: #3b82f6; color: white; } /* Azul */
    .btn-ver { background: #f1f5f9; color: #475569; flex: 0 0 40px; }
    .btn-ver:hover { background: #e2e8f0; color: #1e293b; }

    /* Etiquetas de estado */
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .st-pagado { background: #dcfce7; color: #166534; }
    .st-preparacion { background: #fef3c7; color: #92400e; }
    .st-despachado { background: #dbeafe; color: #1e40af; }

    /* --- ESTILOS DEL MODAL --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; visibility: hidden; transition: all 0.3s ease;
        backdrop-filter: blur(4px);
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-card {
        background: white; width: 100%; max-width: 600px;
        border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        transform: translateY(20px); transition: transform 0.3s ease;
        max-height: 90vh; overflow-y: auto;
    }
    .modal-overlay.active .modal-card { transform: translateY(0); }

    .modal-header {
        padding: 20px 25px; border-bottom: 1px solid #e2e8f0;
        display: flex; justify-content: space-between; align-items: center;
        background: #f8fafc;
    }
    .modal-title { margin: 0; font-size: 1.25rem; color: #1e293b; font-weight: 700; }
    .btn-close { background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; }
    
    .modal-body { padding: 25px; }
    
    .detail-section { margin-bottom: 25px; }
    .detail-title { 
        font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; 
        color: #94a3b8; font-weight: 700; margin-bottom: 10px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px;
    }
    
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.95rem; }
    .info-label { font-weight: 600; color: #64748b; display: block; margin-bottom: 2px; }
    .info-value { color: #1e293b; }

    .table-items { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table-items th { text-align: left; font-size: 0.85rem; color: #64748b; padding: 8px; border-bottom: 1px solid #e2e8f0; }
    .table-items td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; color: #334155; }
    .table-items tr:last-child td { border-bottom: none; }
    .col-price { text-align: right; font-weight: 600; }

    .modal-footer {
        padding: 20px 25px; background: #f8fafc; border-top: 1px solid #e2e8f0;
        text-align: right;
    }
    .total-big { font-size: 1.5rem; font-weight: 800; color: var(--brand-color); }
</style>
{% endblock %}

{% block panel_content %}

    <!-- Filtros -->
    <div class="filters-bar">
        <a href="{% url 'panel_cocina' %}" class="filter-btn {% if not estado_actual %}active{% endif %}">Todos</a>
        <a href="?estado=pagado" class="filter-btn {% if estado_actual == 'pagado' %}active{% endif %}">Por Cocinar</a>
        <a href="?estado=en_preparacion" class="filter-btn {% if estado_actual == 'en_preparacion' %}active{% endif %}">En Cocina</a>
        <a href="?estado=despachado" class="filter-btn {% if estado_actual == 'despachado' %}active{% endif %}">Enviados</a>
    </div>

    <!-- Lista de Pedidos -->
    <div class="pedidos-grid">
        {% for pedido in pedidos %}
        <div class="pedido-card">
            <div class="card-header-p">
                <span class="pedido-id">#{{ pedido.id }}</span>
                <span class="status-badge st-{{ pedido.estado }}">
                    {% if pedido.estado == 'pagado' %}Pagado{% elif pedido.estado == 'en_preparacion' %}Cocinando{% else %}{{ pedido.get_estado_display }}{% endif %}
                </span>
            </div>

            <div class="card-body-p">
                <div class="cliente-info">
                    <!-- FIX: Nombre seguro y visualización correcta -->
                    <div class="avatar-mini">
                        {{ pedido.cliente.first_name|default:pedido.cliente.username|slice:":1"|upper }}
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;">
                            {{ pedido.cliente.first_name }} {{ pedido.cliente.last_name }}
                        </div>
                        <div style="font-size: 0.75rem; color: #94a3b8;">{{ pedido.cliente.email }}</div>
                    </div>
                </div>

                <ul class="items-list">
                    {% for item in pedido.items.all %}
                    <li class="item-row">
                        <span><span class="item-cant">{{ item.cantidad }}x</span> {{ item.producto.nombre }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card-footer-p">
                <div class="actions-row">
                    {% if pedido.estado == 'pagado' %}
                        <a href="{% url 'cambiar_estado_pedido' pedido.id 'en_preparacion' %}" class="btn-action btn-cocinar">
                            <i class="fas fa-fire"></i> A Cocina
                        </a>
                    {% elif pedido.estado == 'en_preparacion' %}
                        <a href="{% url 'cambiar_estado_pedido' pedido.id 'despachado' %}" class="btn-action btn-despachar">
                            <i class="fas fa-box-open"></i> Despachar
                        </a>
                    {% elif pedido.estado == 'despachado' %}
                         <span style="font-size: 0.8rem; color: #64748b; width: 100%; text-align: center; padding: 5px;">
                            <i class="fas fa-check-circle"></i> Completado
                         </span>
                    {% endif %}
                    
                    <!-- CORRECCIÓN AQUÍ: Usamos data-id y onclick="this" para evitar error de sintaxis en el editor -->
                    <button type="button" 
                            class="btn-action btn-ver" 
                            data-id="{{ pedido.id }}" 
                            onclick="abrirModalDetalle(this)" 
                            title="Ver Detalle Completo">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: #94a3b8;">
            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>¡Todo listo! No hay pedidos pendientes en esta categoría.</p>
        </div>
        {% endfor %}
    </div>

    <!-- ESTRUCTURA DEL MODAL (OCULTO) -->
    <div id="modalPedido" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">Pedido #<span id="m-id"></span></h3>
                <button class="btn-close" onclick="cerrarModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Sección Cliente -->
                <div class="detail-section">
                    <div class="detail-title">Información del Cliente</div>
                    <div class="info-grid">
                        <div><span class="info-label">Nombre</span> <span id="m-cliente" class="info-value"></span></div>
                        <div><span class="info-label">Email</span> <span id="m-email" class="info-value"></span></div>
                        <div><span class="info-label">Teléfono</span> <span id="m-telefono" class="info-value"></span></div>
                        <div><span class="info-label">Fecha</span> <span id="m-fecha" class="info-value"></span></div>
                    </div>
                </div>

                <!-- Sección Envío -->
                <div class="detail-section">
                    <div class="detail-title">Datos de Envío</div>
                    <div class="info-grid">
                        <div><span class="info-label">Método</span> <span id="m-metodo-envio" class="info-value"></span></div>
                        <div><span class="info-label">Ciudad</span> <span id="m-ciudad" class="info-value"></span></div>
                        <div style="grid-column: span 2;"><span class="info-label">Dirección</span> <span id="m-direccion" class="info-value"></span></div>
                    </div>
                </div>

                <!-- Sección Productos -->
                <div class="detail-section">
                    <div class="detail-title">Productos</div>
                    <table class="table-items">
                        <thead><tr><th>Cant.</th><th>Producto</th><th class="col-price">Precio</th></tr></thead>
                        <tbody id="m-items-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <div class="total-big">Total: $<span id="m-total"></span></div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    const modal = document.getElementById('modalPedido');
    
    function cerrarModal() {
        modal.classList.remove('active');
    }

    modal.addEventListener('click', function(e) {
        if (e.target === modal) cerrarModal();
    });

    // CORRECCIÓN JS: La función ahora recibe el botón (btn)
    function abrirModalDetalle(btn) {
        // Obtenemos el ID desde el atributo data-id
        const pedidoId = btn.dataset.id;
        
        fetch(`/panel/api/pedido/${pedidoId}/detalle/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('m-id').textContent = data.id;
                document.getElementById('m-cliente').textContent = data.cliente.nombre;
                document.getElementById('m-email').textContent = data.cliente.email;
                document.getElementById('m-telefono').textContent = data.cliente.telefono;
                document.getElementById('m-fecha').textContent = data.fecha;
                
                document.getElementById('m-metodo-envio').textContent = data.envio.metodo || 'Retiro';
                document.getElementById('m-direccion').textContent = data.envio.direccion || '-';
                document.getElementById('m-ciudad').textContent = data.envio.ciudad ? `${data.envio.ciudad} (CP: ${data.envio.cp})` : '-';
                
                document.getElementById('m-total').textContent = data.total.toFixed(2);

                const tbody = document.getElementById('m-items-body');
                tbody.innerHTML = '';
                
                data.items.forEach(item => {
                    const row = `
                        <tr>
                            <td style="font-weight:700; color:var(--brand-color);">${item.cantidad}x</td>
                            <td>${item.producto}</td>
                            <td class="col-price">$${item.subtotal.toFixed(2)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                if (data.envio.costo > 0) {
                    tbody.innerHTML += `
                        <tr style="background:#f8fafc;">
                            <td></td>
                            <td><em>Costo de Envío</em></td>
                            <td class="col-price">$${data.envio.costo.toFixed(2)}</td>
                        </tr>
                    `;
                }

                modal.classList.add('active');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('No se pudieron cargar los detalles.');
            });
    }
</script>
{% endblock %}