{% extends 'panel_gestor/base_panel.html' %}
{% load static %}

{% block title %}Gestión de Suscripciones{% endblock %}

{% block extra_css %}
<style>
    /* Filtros Superiores */
    .filters-bar { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn { 
        padding: 8px 16px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 600; 
        background: white; border: 1px solid #e2e8f0; color: #64748b; transition: all 0.2s; white-space: nowrap; 
    }
    .filter-btn:hover { border-color: var(--brand-color); color: var(--brand-color); }
    .filter-btn.active { background: var(--brand-color); color: white; border-color: var(--brand-color); }

    /* Tabla */
    .table-responsive { overflow-x: auto; border-radius: 12px; box-shadow: var(--shadow-sm); }
    .subs-table { width: 100%; border-collapse: collapse; background: white; min-width: 900px; }
    .subs-table th { background: #f8fafc; padding: 15px; text-align: left; color: #64748b; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
    .subs-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
    .subs-table tr:hover { background: #fdfdfd; }
    
    /* Estados */
    .days-ok { color: #166534; background: #dcfce7; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; font-size: 0.75rem; font-weight: 700;}
    .days-warn { color: #b45309; background: #fef3c7; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; font-size: 0.75rem; font-weight: 700;}
    .days-expired { color: #991b1b; background: #fee2e2; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; font-size: 0.75rem; font-weight: 700;}

    /* Botones de Acción */
    .actions-cell { display: flex; align-items: center; gap: 8px; }
    
    .btn-wsp-mini { 
        background: #25d366; color: white; border: none; width: 34px; height: 34px; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        text-decoration: none; transition: 0.2s; box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3);
    }
    .btn-wsp-mini:hover { background: #128c7e; transform: scale(1.1); }
    
    .btn-extend-mini {
        background: white; border: 1px solid #0ea5e9; color: #0284c7; width: 34px; height: 34px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        text-decoration: none; transition: 0.2s; cursor: pointer;
    }
    .btn-extend-mini:hover { background: #e0f2fe; border-color: #0284c7; }

    .btn-view { 
        color: #64748b; font-size: 1.1rem; padding: 5px; 
        border-radius: 6px; transition: color 0.2s; 
    }
    .btn-view:hover { color: var(--brand-color); background: #f1f5f9; }

    /* --- ESTILOS DEL MODAL (NUEVO PARA ESTA PÁGINA) --- */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 1000; 
        display: none; align-items: center; justify-content: center; 
        backdrop-filter: blur(2px); 
    }
    .modal-overlay.active { display: flex; }
    
    .modal-box { 
        background: white; padding: 30px; border-radius: 16px; 
        width: 90%; max-width: 450px; 
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
    }
    
    .modal-title { 
        margin-top: 0; margin-bottom: 15px; color: #1e293b; 
        border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.2rem;
    }
    
    .modal-text { 
        color: #64748b; font-size: 0.95rem; line-height: 1.5; margin-bottom: 25px; 
    }
    .modal-highlight { font-weight: 700; color: #1e293b; }

    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
    
    .btn-modal { 
        padding: 10px 20px; border-radius: 8px; border: none; 
        font-weight: 600; cursor: pointer; font-size: 0.9rem; text-decoration: none;
    }
    .btn-close { background: #f1f5f9; color: #475569; }
    .btn-save { background: #3b82f6; color: white; display: inline-flex; align-items: center; }
    .btn-save:hover { background: #2563eb; }
</style>
{% endblock %}

{% block panel_content %}

    <!-- Filtros de Estado -->
    <div class="filters-bar">
        <a href="?filtro=activas" class="filter-btn {% if filtro_actual == 'activas' %}active{% endif %}">
            <i class="fas fa-check-circle"></i> Activas
        </a>
        <a href="?filtro=venciendo" class="filter-btn {% if filtro_actual == 'venciendo' %}active{% endif %}">
            <i class="fas fa-exclamation-triangle"></i> Por Vencer (5 días)
        </a>
        <a href="?filtro=vencidas" class="filter-btn {% if filtro_actual == 'vencidas' %}active{% endif %}">
            <i class="fas fa-times-circle"></i> Vencidas (Recuperar)
        </a>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
        <table class="subs-table">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Vencimiento</th>
                    <th>Estado / Días Restantes</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for perfil in perfiles %}
                <tr>
                    <td>
                        <div style="font-weight: 600; color: #1e293b;">
                            {{ perfil.user.first_name }} {{ perfil.user.last_name }}
                        </div>
                        <div style="color:#94a3b8; font-size: 0.85rem;">{{ perfil.user.email }}</div>
                    </td>
                    <td>
                        <i class="far fa-calendar-alt" style="color:#cbd5e1; margin-right:5px;"></i>
                        {{ perfil.suscripcion_activa_hasta|date:"d/m/Y" }}
                    </td>
                    <td>
                        <!-- Lógica visual de días restantes -->
                        {% if perfil.suscripcion_activa_hasta < hoy %}
                            <span class="days-expired">VENCIDA</span>
                            <div style="font-size:0.8rem; color:#991b1b; margin-top:3px;">
                                hace {{ perfil.suscripcion_activa_hasta|timesince:hoy }}
                            </div>
                        {% else %}
                            {% if perfil.suscripcion_activa_hasta <= hoy|add:"5 days" %}
                                <span class="days-warn">⚠️ Vence pronto</span>
                            {% else %}
                                <span class="days-ok">Activa</span>
                            {% endif %}
                            
                            <div style="font-size:0.85rem; color:#475569; margin-top:3px;">
                                Quedan <strong>{{ perfil.suscripcion_activa_hasta|timeuntil:hoy }}</strong>
                            </div>
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        <!-- 1. WhatsApp -->
                        <a href="https://wa.me/?text=Hola {{ perfil.user.first_name }}, te recordamos que tu suscripción vence el {{ perfil.suscripcion_activa_hasta|date:'d/m' }}." 
                           target="_blank" class="btn-wsp-mini" title="Enviar recordatorio">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        
                        <!-- 2. Extender Suscripción (CORREGIDO) -->
                        <!-- Usamos data-url y data-email para pasar los valores al JS -->
                        <button class="btn-extend-mini" 
                                data-url="{% url 'extender_suscripcion_manual' perfil.user.id %}"
                                data-email="{{ perfil.user.email }}"
                                onclick="abrirModalExtender(this)"
                                title="Extender 30 días">
                            <i class="fas fa-calendar-plus"></i>
                        </button>

                        <!-- 3. Ver Ficha -->
                        {% if perfil.user.ficha_paciente %}
                            <a href="{% url 'panel_detalle_paciente' perfil.user.ficha_paciente.id %}" class="btn-view" title="Ver Ficha Clínica">
                                <i class="fas fa-eye"></i>
                            </a>
                        {% else %}
                             <span class="btn-view" style="opacity:0.3; cursor:not-allowed;" title="Sin Ficha Clínica"><i class="fas fa-eye-slash"></i></span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 50px; color: #94a3b8;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                        <p>No se encontraron suscripciones en esta categoría.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- MODAL EXTENDER SUSCRIPCIÓN -->
    <div id="modalExtenderLista" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" style="color: #0284c7;">Regalar Suscripción</h3>
            <p class="modal-text">
                ¿Confirmas agregar <strong>30 días</strong> de acceso al recetario para <span id="modal-user-email" class="modal-highlight"></span>?
            </p>
            <div class="modal-footer">
                <button class="btn-modal btn-close" onclick="cerrarModalExtender()">Cancelar</button>
                <a href="#" id="btn-confirmar-extender" class="btn-modal btn-save">Confirmar Extensión</a>
            </div>
        </div>
    </div>

    <script>
        // La función ahora recibe el botón (btn) y extrae los datos de sus atributos
        function abrirModalExtender(btn) {
            const url = btn.dataset.url;
            const email = btn.dataset.email;
            
            document.getElementById('modal-user-email').textContent = email;
            document.getElementById('btn-confirmar-extender').href = url;
            document.getElementById('modalExtenderLista').classList.add('active');
        }

        function cerrarModalExtender() {
            document.getElementById('modalExtenderLista').classList.remove('active');
        }
    </script>

{% endblock %}