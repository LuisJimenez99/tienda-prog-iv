{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- 1. Cargamos el script del SDK de Mercado Pago. Esencial para que todo funcione. -->
<script src="https://sdk.mercadopago.com/js/v2"></script>

<div class="checkout-wrapper">
    <h2>Confirma y Paga tu Turno</h2>
    
    <div class="resumen-turno">
        <h3>Resumen de tu Cita</h3>
        <p><strong>Fecha:</strong> {{ turno.fecha|date:"l, d \d\e F \d\e Y" }}</p>
        <p><strong>Hora:</strong> {{ turno.hora|time:"H:i" }} hs</p>
        <p><strong>Precio:</strong> ${{ precio|floatformat:2 }}</p>
    </div>

    <div class="metodos-pago">
        <div class="pago-opcion">
            <h4>1. Paga online con Mercado Pago</h4>
            <p>Tarjetas de crédito, débito y otros medios de pago. La confirmación es inmediata.</p>
            
            <!-- 2. Este es el contenedor donde Mercado Pago dibujará su botón de pago. -->
            <div id="wallet_container" style="margin-top: 15px;"></div>
        </div>
        
        <div class="pago-opcion">
            <h4>2. Transferencia Bancaria</h4>
            <p>Si eliges esta opción, finaliza la reserva y envía el comprobante por WhatsApp. Tu turno quedará pendiente de confirmación manual.</p>
            <div class="datos-transferencia">
                <strong>Alias/CBU:</strong> {{ datos_pago.cbu_alias|default:"No configurado" }}
            </div>
            <!-- Este botón te llevará a la página que crearemos en el futuro para manejar la confirmación por transferencia -->
            <a href="{% url 'confirmar_reserva' %}" class="btn-principal" style="margin-top: 20px;">Finalizar con Transferencia</a>
        </div>
    </div>
</div>

<script>
    // 3. Este script inicializa el checkout de Mercado Pago.
    //    Usa la Public Key que le pasamos desde la vista de Python.
    const mp = new MercadoPago('{{ public_key }}', {
        locale: 'es-AR' // Configuramos el idioma a español de Argentina
    });

    // Creamos el componente 'wallet' (el botón de pago) dentro del div 'wallet_container'.
    mp.bricks().create("wallet", "wallet_container", {
        initialization: {
            // Le pasamos el ID de la preferencia de pago que generó nuestro backend.
            preferenceId: "{{ preference_id }}",
        },
        customization: {
            texts: {
                valueProp: 'smart_option', // Muestra textos como "Paga con tu cuenta de Mercado Pago"
            },
        }
    });
</script>
{% endblock %}

