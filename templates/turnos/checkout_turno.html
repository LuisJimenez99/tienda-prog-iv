{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <!-- Vinculamos el CSS mejorado -->
  <link rel="stylesheet" href="{% static 'css/pages/checkout_turno.css' %}">
{% endblock %}

{% block content %}
<!-- Contenedor principal con la clase correcta -->
<div class="checkout-wrapper">
    
    <div class="checkout-card">
        <!-- Encabezado de la Tarjeta -->
        <div class="card-header">
            <h2>Confirmar Reserva</h2>
            <p>Estás a un paso de agendar tu consulta.</p>
        </div>

        <!-- Resumen del Turno (Ticket) -->
        <div class="turno-ticket">
            <div class="ticket-row">
                <span class="ticket-label"><i class="far fa-calendar-alt"></i> Fecha:</span>
                <!-- Formato legible: Lunes 10 de Diciembre -->
                <span class="ticket-value">{{ turno.fecha|date:"l d \d\e F"|capfirst }}</span>
            </div>
            <div class="ticket-row">
                <span class="ticket-label"><i class="far fa-clock"></i> Hora:</span>
                <span class="ticket-value">{{ turno.hora|time:"H:i" }} hs</span>
            </div>
            <div class="ticket-row">
                <span class="ticket-label"><i class="fas fa-user-md"></i> Servicio:</span>
                <span class="ticket-value">Nutrición General</span>
            </div>
            <hr class="ticket-divider">
            <div class="ticket-row total">
                <span class="ticket-label">Total a Pagar:</span>
                <span class="ticket-value precio">${{ precio|floatformat:0 }}</span>
            </div>
        </div>

        <!-- Selección de Pago -->
        <div class="pago-section">
            <h3>Selecciona forma de pago:</h3>

            <!-- Opción 1: Mercado Pago -->
            <div class="metodo-pago mp-box">
                <div class="mp-header">
                    <!-- Logo oficial de MP (puedes cambiar la URL si prefieres uno local) -->
                    <img src="https://logotipoz.com/wp-content/uploads/2021/10/version-horizontal-large-logo-mercado-pago.webp" alt="Mercado Pago" class="mp-logo">
                </div>
                <p class="mp-desc">Tarjetas de crédito, débito o dinero en cuenta.</p>
                <!-- Aquí el SDK de MP inyectará el botón de pago -->
                <div id="wallet_container"></div>
            </div>

            <!-- Separador visual -->
            <div class="separador-o"><span>O</span></div>

            <!-- Opción 2: Transferencia Bancaria -->
            <div class="metodo-pago transferencia-box">
                <div class="transf-header">
                    <i class="fas fa-university"></i>
                    <h4>Transferencia Bancaria</h4>
                </div>
                <p class="transf-desc">
                    Alias: <strong>{{ datos_pago.cbu_alias }}</strong><br>
                    <small>Envía el comprobante por WhatsApp para confirmar.</small>
                </p>
                
                <!-- Botón que lleva a la vista de confirmación manual -->
                <a href="{% url 'confirmar_transferencia_turno' turno.id %}" class="btn-transferencia">
                    Reservar con Transferencia
                </a>
            </div>
        </div>
    </div>

</div>

<!-- SDK de Mercado Pago (Frontend) -->
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
    // Inicializamos MP con la clave pública del contexto
    const mp = new MercadoPago("{{ public_key }}");
    const bricksBuilder = mp.bricks();
    
    // Creamos el botón de pago ("Wallet Brick")
    mp.bricks().create("wallet", "wallet_container", {
        initialization: {
            preferenceId: "{{ preference_id }}", // ID generado en el backend
        },
        customization: {
            texts: {
                action: 'pay',
                valueProp: 'security_details',
            },
        },
    });
</script>
{% endblock %}